# .github/workflows/deploy-supabase.yml
# Automated deployment of Supabase Edge Functions and migrations
#
# Triggers:
#   - Push to main branch (when supabase/ files change)
#   - Manual dispatch for ad-hoc deployments
#
# Required Secrets:
#   - SUPABASE_ACCESS_TOKEN: Personal access token from supabase.com/dashboard/account/tokens
#   - SUPABASE_PROJECT_REF: Project reference ID (from project URL or settings)

name: Deploy Supabase

on:
  push:
    branches: [main]
    paths:
      - "supabase/functions/**"
      - "supabase/migrations/**"
  workflow_dispatch:
    inputs:
      deploy_functions:
        description: "Deploy Edge Functions"
        required: true
        default: true
        type: boolean
      run_migrations:
        description: "Run database migrations"
        required: true
        default: true
        type: boolean

env:
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  deploy:
    name: Deploy to Supabase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify secrets are configured
        run: |
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "‚ùå SUPABASE_PROJECT_REF secret is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Link Supabase project
        run: supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Deploy Edge Functions
        if: github.event_name == 'push' || github.event.inputs.deploy_functions == 'true'
        run: |
          echo "üöÄ Deploying Edge Functions..."
          supabase functions deploy send-push
          echo "‚úÖ Edge Functions deployed successfully"

      # - name: Run database migrations
      #   if: github.event_name == 'push' || github.event.inputs.run_migrations == 'true'
      #   run: |
      #     echo "üóÑÔ∏è Running database migrations..."
      #     supabase db push
      #     echo "‚úÖ Migrations applied successfully"

      - name: Verify webhook configuration
        run: |
          echo "üîç Verifying webhook configuration..."
          node scripts/verify-webhook-config.js
        continue-on-error: true

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "‚ùå Supabase deployment failed!"
          echo "Check the workflow logs for details."
          echo "Common issues:"
          echo "  - Missing or invalid SUPABASE_ACCESS_TOKEN"
          echo "  - Missing or invalid SUPABASE_PROJECT_REF"
          echo "  - Edge Function syntax errors"
          echo "  - Migration conflicts"
