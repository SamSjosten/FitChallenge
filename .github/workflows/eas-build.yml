# .github/workflows/eas-build.yml
# ============================================
# EAS Build Workflow
# ============================================
# Builds iOS and Android apps using Expo EAS.

name: EAS Build

on:
  # Manual trigger with build profile selection
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to build"
        required: true
        default: "ios"
        type: choice
        options:
          - ios
          - android
          - all
      profile:
        description: "Build profile"
        required: true
        default: "preview"
        type: choice
        options:
          - development
          - preview
          - production
      submit:
        description: "Submit to store after build"
        required: false
        default: false
        type: boolean

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build-ios:
    name: Build iOS
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS app
        run: |
          eas build \
            --platform ios \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive \
            --no-wait

      - name: Get build URL
        run: |
          echo "Build started. Check Expo dashboard for status."
          echo "https://expo.dev/accounts/[account]/projects/FitChallenge/builds"

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Android app
        run: |
          eas build \
            --platform android \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive \
            --no-wait

  submit-ios:
    name: Submit iOS to App Store
    runs-on: ubuntu-latest
    needs: build-ios
    if: (github.event.inputs.submit == 'true' && github.event.inputs.profile == 'production') || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store Connect
        run: |
          eas submit \
            --platform ios \
            --latest \
            --non-interactive
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  submit-android:
    name: Submit Android to Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: (github.event.inputs.submit == 'true' && github.event.inputs.profile == 'production') || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        run: |
          eas submit \
            --platform android \
            --latest \
            --non-interactive

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-ios, build-android]
    if: always()

    steps:
      - name: Build Status Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "✅ iOS build started successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-ios.result }}" == "skipped" ]; then
            echo "⏭️ iOS build skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ iOS build failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "✅ Android build started successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-android.result }}" == "skipped" ]; then
            echo "⏭️ Android build skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Android build failed" >> $GITHUB_STEP_SUMMARY
          fi
